<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Protected Page with Data</title>
    <!--General Bootsrap to Ease Work-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
     <!--Favicon-->
     <link rel="icon" type="image/x-icon" href="../favicon.ico"/>
    <!--Social Media Buttons CSS -->
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/gh/vaakash/socializer@master/css/socializer.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
    <!--Local Files -->
    <link rel="stylesheet" href="./css/register.css">
    <!-- For functions -->
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!--Yoinked-->
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, shrink-to-fit=no">
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="Header">
            <div class="navbar-wrapper ">
                <div class="navbar-local navbar navbar-expand-lg light is-scrolled">
                    <div class="container position-relative" style="flex-wrap:nowrap">
                        <a class="navbar-brand" href="/">
                            <img src="https://hierabsd.id/wp-content/uploads/2022/11/hiera-bsd-logo-rec.png"
                                class="img-fluid dark" alt="Logo" width="auto">
                            <!--<img src="img/LightVersion.png" class="img-fluid light" alt="Logo" width="auto">-->
                        </a>
                        <div class="navbar-toggler">
                            <button aria-label="toggler-menu" onclick="openNav()" class="">
                                <i class="fa-solid fa-bars"></i>
                            </button>
                        </div>
                        <div class="navbar-menu light d-lg-block">
                            <div class="navbar-menu-bg"></div>
                            <div class="navbar-menu-content">
                                <div class="navbar-collapse">
                                    <ul class="navbar-nav ml-auto">
                                        <li class="nav-item false">
                                            <div>
                                                <a class="nav-link" href="https://hiera.co.id/">Main Site</a>
                                            </div>
                                        </li>
                                        <li class="nav-item false">
                                            <div>
                                                <a class="nav-link"id="logout">Logout</a>
                                            </div>
                                        </li>

                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="navbar-menu light d-lg-none" id="dropdownnavmenu" style="/*display: none;*/">
                            <div class="white-layer">
                                <div class="navbar-menu-content" id="whitesecond"
                                    style="transform-origin: 487px 481px; transform: translate(0px, 0px); height: 25%; width: 80%;">
                                    <div class="navbar-collapse">
                                        <ul class="navbar-nav">
                                            <li class="nav-item">
                                                <div><a class="nav-link" href="/">Main Site</a></div>
                                            </li>
                                            <li class="nav-item">
                                                <div> <a class="nav-link" id="logout2">Logout</a> </div>
                                            </li>

                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

        </div>
        <h1>Dashboard</h1>


        <div class="container ">
            <h2>Scan QR Codes</h2>
            <div class="section d-flex flex-row">
                <div id="my-qr-reader" class="flex-fill">
                </div>
                <div class="flex-fill border">   
                    <div class="p-2">
                        <div class="p-2">
                            <span>User ID: </span><span id="id"></span>
                        </div>
                        <div class="p-2">
                            <span>Name: </span><span id="got-name"></span>
                        </div>
                        <div class="p-2">
                            <span>Email: </span><span id="got-email"></span>
                        </div>
                        <div class="p-2">
                            <span>Phone Number: </span><span id="got-no"></span>
                        </div>
                        <div class="p-2">
                            <span>Company: </span><span id="got-company"></span>
                        </div>
                        <div class="p-2">
                            <button id="mark">Mark as Attending</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <!--The QR Code Scripts-->
        <script
            src="https://unpkg.com/html5-qrcode">
        </script>
        <script src="script.js"></script>


        <h2>Guest List</h2>
        <table id="data-table" class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Company</th>
                    <th>Email</th>
                    <th>Phone Number</th>
                    <th>Attending</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <button id="export">Export to Excel</button>
    </div>



    <script type="module">
        import { auth } from '../firebase-config.js'; //REMEMEBR TO DIRECT IT PROPERLY!
        import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.8.0/firebase-auth.js';
        import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/9.8.0/firebase-database.js';

        const database = getDatabase();
        const dataTableBody = document.getElementById('data-table').querySelector('tbody');

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = '../index.html';
            } else {
                const dataRef = ref(database, 'guests');
                onValue(dataRef, (snapshot) => {
                    const data = snapshot.val();
                    dataTableBody.innerHTML = '';
                    for (let key in data) {
                        let row = data[key];
                        dataTableBody.innerHTML += `
              <tr>
                <td>${row.id}</td>
                <td>${row.name}</td>
                <td>${row.company}</td>
                <td>${row.email}</td>
                <td>${row.phoneno}</td>
                <td>${row.attending ? 'Yes' : 'No'}</td>
              </tr>
            `;
                    }
                });
            }
        });

        document.getElementById('logout').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = '../index.html';
            }).catch((error) => {
                console.error('Logout error', error);
            });
        });

        document.getElementById('logout2').addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = '../index.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // Export data to Excel function
        document.getElementById('export').addEventListener('click', () => {
            exportTableToExcel('data-table', 'guests_data');
        });

        // Function to export table data to Excel
        function exportTableToExcel(tableID, filename = '') {
            let downloadLink;
            let dataType = 'application/vnd.ms-excel';
            let tableSelect = document.getElementById(tableID);
            let tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');
            filename = filename ? filename + '.xls' : 'excel_data.xls';
            downloadLink = document.createElement("a");
            document.body.appendChild(downloadLink);

            if (navigator.msSaveOrOpenBlob) {
                let blob = new Blob(['\ufeff', tableHTML], {
                    type: dataType
                });
                navigator.msSaveOrOpenBlob(blob, filename);
            } else {
                downloadLink.href = 'data:' + dataType + ', ' + tableHTML;

                downloadLink.download = filename;

                downloadLink.click();
            }
        }
    </script>
    <script  type="module">
        import { getDatabase, ref, onValue, set } from 'https://www.gstatic.com/firebasejs/9.8.0/firebase-database.js';
        

        function domReady(fn) {
            if (
                document.readyState === "complete" ||
                document.readyState === "interactive"
            ) {
                setTimeout(fn, 1000);
            } else {
                document.addEventListener("DOMContentLoaded", fn);
            }
        }
        
        domReady(function () {
        
            // If found you qr code
            function onScanSuccess(decodeText, decodeResult) {
                // alert("You Qr is : " + decodeText, decodeResult);
                document.getElementById('id').innerText = decodeText;
                const database = getDatabase();
                const dataRef = ref(database, 'guests/' + decodeText);
                onValue(dataRef, (snapshot) => {
                const readData = snapshot.val();
                console.log(readData)
                document.getElementById('got-name').innerText = readData.name;
                document.getElementById('got-email').innerText = readData.email;
                document.getElementById('got-no').innerText = readData.phoneno;
                document.getElementById('got-company').innerText = readData.company;
                });
            }
        
            let htmlscanner = new Html5QrcodeScanner(
                "my-qr-reader",
                { fps: 10, qrbos: 250 }
            );
            htmlscanner.render(onScanSuccess);
        });

        document.getElementById('mark').addEventListener('click', () => {
            const database = getDatabase();
            const dataRef = ref(database, 'guests/' + document.getElementById('id').innerText);
            onValue(dataRef, (snapshot) => {
                const readData = snapshot.val();
                readData.attending = true;
                set(ref(database, 'guests/' + document.getElementById('id').innerText), readData);
            });
            alert("Marked as attending!");
        });
        
    </script>
</body>

</html>