<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Protected Page with Data</title>
    <!--General Bootsrap to Ease Work-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!--Social Media Buttons CSS -->
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/gh/vaakash/socializer@master/css/socializer.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
    <!--Local Files -->
    <link rel="stylesheet" href="./css/register.css">
    <!-- For functions -->
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!--Yoinked-->
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, shrink-to-fit=no">
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="Header">
            <div class="navbar-wrapper ">
                <div class="navbar-local navbar navbar-expand-lg light is-scrolled">
                    <div class="container position-relative" style="flex-wrap:nowrap">
                        <a class="navbar-brand" href="/">
                            <img src="https://hierabsd.id/wp-content/uploads/2022/11/hiera-bsd-logo-rec.png"
                                class="img-fluid dark" alt="Logo" width="auto">
                            <!--<img src="img/LightVersion.png" class="img-fluid light" alt="Logo" width="auto">-->
                        </a>
                        <div class="navbar-toggler">
                            <button aria-label="toggler-menu" onclick="openNav()" class="">
                                <i class="fa-solid fa-bars"></i>
                            </button>
                        </div>
                        <div class="navbar-menu light d-lg-block">
                            <div class="navbar-menu-bg"></div>
                            <div class="navbar-menu-content">
                                <div class="navbar-collapse">
                                    <ul class="navbar-nav ml-auto">
                                        <li class="nav-item false">
                                            <div>
                                                <a class="nav-link" href="https://hiera.co.id/">Main Site</a>
                                            </div>
                                        </li>
                                        <li class="nav-item false">
                                            <div>
                                                <a class="nav-link"id="logout">Logout</a>
                                            </div>
                                        </li>

                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="navbar-menu light d-lg-none" id="dropdownnavmenu" style="/*display: none;*/">
                            <div class="white-layer">
                                <div class="navbar-menu-content" id="whitesecond"
                                    style="transform-origin: 487px 481px; transform: translate(0px, 0px); height: 25%; width: 80%;">
                                    <div class="navbar-collapse">
                                        <ul class="navbar-nav">
                                            <li class="nav-item">
                                                <div><a class="nav-link" href="/">Main Site</a></div>
                                            </li>
                                            <li class="nav-item">
                                                <div> <a class="nav-link" id="logout2">Logout</a> </div>
                                            </li>

                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

        </div>
        <div class="d-flex flex-column container mt-5">
            <div class="pt-5 flex-fill">
                <h1>Dashboard</h1>
            </div>
            <center><div id="user-info">Loading...</div></center>
            <div id="qr-code-container px-auto flex-fill">
                <center><img id="qr-code-img" alt="QR Code" style="display:none;" /></center>
            </div>
        </div>


    </div>



    <script type="module">
        import { auth } from './firebase-config.js'; // Ensure this path is correct
        import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.8.0/firebase-auth.js';
        import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/9.8.0/firebase-database.js';
    
        const database = getDatabase();
    
        document.addEventListener('DOMContentLoaded', () => {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    await checkUserInDatabase(user.email);
                } else {
                    document.getElementById('user-info').innerHTML = 'User not signed in';
                }
            });
        });
    
        async function checkUserInDatabase(email) {
            const usersRef = ref(database, 'guests');
            try {
                const snapshot = await get(usersRef);
                let found = false;
    
                snapshot.forEach(childSnapshot => {
                    const userData = childSnapshot.val();
                    if (userData.email === email) {
                        found = true;
                        displayUserData(userData);
                    }
                });
    
                if (!found) {
                    document.getElementById('user-info').innerHTML = 'No data found for this user';
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
            }
        }
    
        function displayUserData(userData) {
            const userInfoDiv = document.getElementById('user-info');
            userInfoDiv.innerHTML = `<h2>Welcome, ${userData.email}</h2>`;
            if (userData.qrCodeURL) {
                const qrCodeImg = document.getElementById('qr-code-img');
                qrCodeImg.src = userData.qrCodeURL;
                qrCodeImg.style.display = 'block'; // Make sure the image is visible
            }
            // Display additional user data as needed
        }
    
        document.getElementById('logout').addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = './index.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        });
        document.getElementById('logout2').addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = './index.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        });
    </script>
    <script src="./js/index.js" type="text/javascript"></script>

</body>

</html>